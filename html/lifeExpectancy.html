<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Global Health Analysis</title>
	<link rel="stylesheet" href="../public/css/style.css"/>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://d3js.org/d3.v5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.js"></script>
	<script src="https://d3js.org/d3-geo-projection.v2.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.9.0/d3-legend.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
  <script src="../public/js/script.js"></script>
  <script src="../public/js/map.js"></script>
  <script type="application/javascript" src="../public/js/TreeMap.js"></script>
  <script type="application/javascript" src="../public/js/pc.js"></script>
   <style>
      .axis {
        font: 12px Serif;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .axis--y path {
        display: none;
      }

      .bar {
        fill: #D27E6D;
        fill-opacity: .7;
      }

      .wld {
        fill: #9ecae1;
      }
      
      .chart-title {
        font-size: 25px;
        font-family: serif;
        margin-top: 30px;
      }
      
      .source {
        margin-top: 0;
        font-size: 14px;
      }
      .title{
        margin:auto;
        text-align: center;
        font-weight: bold;
        font-size: 100px Serif;
        /*font-style: oblique;*/
      }
      .sub-title{
        color: black;
        font-weight: bold;
        font-size: 100px Serif;
        margin-left: 5px;
      }
    </style>
</head>
<body>
<div class="jumbotron text-center" style="margin-bottom:0">
	<h1 class="global_title">Our Findings</h1>
</div>
<nav class="navbar navbar-inverse">
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li>
        	<a href="../index.html">Home</a>
        </li>
        <li>
        	<a href="">Health factors</a>
        </li>
        <li>
        	<a href="treeMap.html">Causes of death</a>
        </li>
        <li class="active">
          <a href="html/lifeExpectancy.html">Our Findings</a>
        </li>
        <li>
           <a href="processVideo.html">Process book and Demo</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
 <div class="wrapper">
      <div class="title">
        <h class="chart-title">Does Political Stability Affect Life Expectancy?</h>
      </div>
    <div id="causesOfDeathBottomDiv">
      <div>
        <h4 class="sub-title">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspLife Expectancy (%) <span class="year"></span></h4>
        <div class="chart"></div>
      </div>
      <div>
        <h4 class="sub-title">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspPolitical Stability <span class="year"></span></h4>
        <div class="lineChart"></div>
      </div>
    </div>
</div>
  <script>
    'use strict';
  
    const margin = {top: 20, right: 30, bottom: 40, left: 100};
    const width = 600 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;
    const percentFormat = d3.format('.0%');
    const leftPadding = 5;

    //line chart
    this.politicalStability = [];
    this.padding = 50;
    this.selectedCon = "SYR";
    this.selectedYears = [];
    this.div = d3.select("body").append("div")
        .attr("class", "tooltip2")				
        .style("opacity", 0); 

    const delay = function(d, i) {
      return i * 50;
    };
  
    function sortData(data) {
      return data.sort((a, b) => b.value - a.value);
    }
  
    function removeGeoAreasWithNoData(data) {
      return data.filter(d => d.value);
    }
  
    function prepareData(data) {
      return data.reduce((accumulator, d) => {
        Object.keys(d).forEach((k) => {
          if (!Number.isInteger(+k)) { return; }
          let value;
          if (d[+k] === '..') {
            value = 0;
          } else {
            value = +d[+k] / 100;
          }
          const newEntry = {
            value,
            geoCode: d.CountryCode,
            geoName: d.Country,
          };
          if (accumulator[+k]) {
            accumulator[+k].push(newEntry);
          } else {
            accumulator[+k] = [newEntry];
          }
        });
        return accumulator;
      }, {});
    }
  
    function xAccessor(d) {
      return d.value;
    }
  
    function yAccessor(d) {
      return d.geoName;
    }
  
    const xScale = d3.scaleLinear()
        .range([0, width])
        .domain([0.5, 0.85]);
  
    const yScale = d3.scaleBand()
        .rangeRound([0, height], 0.1)
        .padding(0.3);
  
    function drawXAxis(el) {
      el.append('g')
          .attr('class', 'axis axis--x')
          .attr('transform', `translate(${leftPadding},${height})`)
          .call(d3.axisBottom(xScale).tickFormat(percentFormat));
    }
  
    function drawYAxis(el, data, t) {
      let axis = el.select('.axis--y');
      if (axis.empty()) {
        axis = el.append('g')
          .attr('class', 'axis axis--y');
      }
  
      axis.transition(t)
          .call(d3.axisLeft(yScale))
        .selectAll('g')
          .delay(delay);
    }
  
    function drawBars(el, data, t) {
      let barsG = el.select('.bars-g');
      if (barsG.empty()) {
        barsG = el.append('g')
          .attr('class', 'bars-g');
      }
  
      const bars = barsG
        .selectAll('.bar')
        .data(data, yAccessor);
      bars.exit()
        .remove();
      bars.enter()
        .append('rect')
          .attr('class', d => d.geoCode === 'WLD' ? 'bar wld' : 'bar')
          .attr('x', leftPadding)
        .merge(bars).transition(t)
          .attr('y', d => yScale(yAccessor(d)))
          .attr('width', d => xScale(xAccessor(d)))
          .attr('height', yScale.bandwidth())
          .delay(delay);
    }
  
    const svg = d3.select('.chart').append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
      .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
    
    
    const lineSvg = d3.select('.lineChart').append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    //line chart
    let that = this;
    d3.csv("../data/changed_csv/political_stability.csv").then( polStability => {
        that.politicalStability.push(polStability);
        setTimeout(lineChartData(), 3000);
    });
    function lineChartData(){
      that.politicalStability.forEach(function(element){
      });
    }
    
    function drawLineChart(currentYear){
      that.selectedYears.push(currentYear);
      console.log(that.selectedYears);
      let svgContainer = d3.select(".lineChart").select("svg");
      svgContainer.selectAll("g").remove();
      svgContainer = svgContainer.append("g").attr("transform", "translate(" + that.padding + "," + that.padding + ")");
      let textPadding = 70;
      let lineChartData = [];
      let yearBuffer = 1;
      let dataBuffer = 0.5;
      that.politicalStability.forEach(function(ele){
        ele.forEach(function(element){
          if(that.selectedCon == element["ID"]){
            that.selectedYears.forEach(function(year){
              lineChartData.push({"year": parseInt(year), "value": parseFloat(element[year])}); 
            });
          }   
        });
      }); 
      console.log(lineChartData)
      let rangeWidth = width - margin.left - margin.right;
      let rangeHeight = height + margin.top + margin.bottom;
      let x = d3.scaleLinear().domain([Math.min.apply(null, that.selectedYears) - yearBuffer, Math.max.apply(null, that.selectedYears)+ yearBuffer]).range([0, rangeWidth]); 
      let y = d3.scaleLinear().domain([d3.min(lineChartData, function(d) { return d.value; })-dataBuffer, d3.max(lineChartData, function(d) { return d.value; })+dataBuffer]).range([rangeHeight-100, 50]);
      let xAxis = d3.axisBottom(x).ticks(5);
      let yAxis = d3.axisLeft(y).ticks(5);

      svgContainer.append("g").attr("transform", "translate("+textPadding+"," + (rangeWidth) + ")").call(xAxis);
      svgContainer.append("g").attr("transform", "translate(" +textPadding+ ",-60)").call(yAxis);
      svgContainer.append("text")             
          .attr("transform","translate(" + ((rangeWidth/2)+textPadding) + " ," + (rangeHeight -100) + ")")
          .style("text-anchor", "middle")
          .text("Year");
      svgContainer.append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0)
          .attr("x",0 - (rangeHeight / 4))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("Political Stability");

      let valueline = d3.line()
        .x(function(d) { return x(d.year); })
        .y(function(d) { return y(d.value); });
      let pathValue = svgContainer.append("path")
        .attr("d", valueline(lineChartData))
        .attr("stroke", "#2E1114")
        .attr("stroke-width", 2)
        .attr("fill", " none")
        .attr("transform", "translate(" +textPadding+ ",-60)");
      let totalLength = pathValue.node().getTotalLength();
      pathValue.attr("stroke-dasharray", totalLength + " " + totalLength)
        .attr("stroke-dashoffset", totalLength)
        .attr("stroke-dashoffset", 0);

      svgContainer.selectAll("circle")
        .data(lineChartData)
        .enter().append("circle")
        .attr("r", 5)
        .attr("cx", function(d) { return x(d.year); })
        .attr("cy", function(d) { return y(d.value); })
        .attr("transform", "translate(" +textPadding+ ",-60)")
        .attr("fill", "#453344")
        .on("mouseover", function(d) {		
            that.div.transition().duration(200).style("opacity", .9);		
            that.div.html("YEAR: "+d.year + "<br/> Value: "  + d.value )	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
            })					
        .on("mouseout", function(d) {		
            that.div.transition().duration(500).style("opacity", 0);	
        }); 
      
      // svgContainer.append("text")
      //     .data(lineChartData)
      //     .enter().append("text")
      //     .attr("transform", "translate(" +textPadding+ ",-60)")
      //     .attr("y", function(d) { return x(d.year); })
      //     .attr("x", function(d) { return x(d.year); })
      //     .text(function(d) { return d.value;});
    }
    fetch('../data/dataold.csv')
      .then((res) => res.text())
      .then((res) => {
        const data = prepareData(d3.csvParse(res));
        const years = Object.keys(data).map(d => +d);
        const lastYear = years[years.length - 1];
        let startYear = years[0];
        let selectedData = removeGeoAreasWithNoData(sortData(data[startYear]));
        let geoAreas = selectedData.map(yAccessor);
  
        d3.select('.year').text(startYear);
  
        yScale.domain(geoAreas);
        drawXAxis(svg, selectedData);
        drawYAxis(svg, selectedData);
        drawBars(svg, selectedData);
  
        const interval = d3.interval(() => {
          const t = d3.transition().duration(2500);
  
          startYear += 1;
          selectedData = removeGeoAreasWithNoData(sortData(data[startYear]));
  
          d3.select('.year').text(startYear);
  
          yScale.domain(selectedData.map(yAccessor));
          drawYAxis(svg, selectedData, t);
          drawBars(svg, selectedData, t);
          drawLineChart(startYear);
          
          if (startYear === lastYear) {
            interval.stop();
          }
        }, 2000);
      });
  </script>
  </body>
  </html>